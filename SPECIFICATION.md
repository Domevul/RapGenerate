## まとめ

このゲームの核心は:
1. **事前構築**での戦略(デッキ構築)
2. **準備フェーズ**での戦術(相手を読んで選択)
3. **攻撃フェーズ**でのフィラーと技術(リズムゲーム)
4. **リソース管理**での判断(ライミングの温存 vs 使い切り)

音ゲーの「タイミング精度が全て」ではなく、
ラップバトルの「ライミング・意味・リズム」のバランスを楽しむゲーム。

単純なじゃんけんではなく、
**トレードオフ**と**リソース管理**と**読み合い**が生む深い駆け引き。# 一人用ラップバトルゲーム 仕様書

## ゲームコンセプト

### 核となる面白さ
ラップバトルの本質的な面白さは以下の3要素:
1. **韻が踏めていること**
2. **リズムがはまっていること**
3. **意味が通じていること**

既存の音ゲーとの差別化ポイント:
- 音ゲー:タイミング精度が**すべて**(譜面固定、選択の余地なし)
- 本ゲーム:タイミングは**最低限**で、韻と意味の組み合わせこそが本質

### ゲームの流れ
```
事前構築(デッキ構築)
  ↓
バトル開始
  ↓
[相手ターン] → 観察・分析
  ↓
[準備フェーズ] → 4つのコロケーション選択・配置(8秒)
  ↓
[攻撃フェーズ] → リズムゲームパート(8秒)
  ↓
[結果判定] → スコア計算・ダメージ
  ↓
次のターンへ(3~5ターンで勝敗決定)
```

---

## 用語定義

### コロケーション
- 2~4単語の固まりで構成される完結した文節
- 例:「綺麗ごとばっかで耳が痛い」「まだまだ悪口言い足りない」
- 各コロケーションには以下の属性が付与される:
  - **タイプ**(#ディス、#ボースティング、#カウンター、#ピキュリア、#エニグマ)
  - **ライミング**(韻の母音、子音など）

### フィラー
- 「yo」「マジで」「おまえ」「ハハ」などの短い装飾・接続詞
- コロケーション間に自動挿入される
- プレイヤーはリズムに合わせてタップするのみ(選択要素なし)
- 文章の繋がりを自然にする役割

### ライミング
- 同じ韻を踏むコロケーションのセット
- 例:ライミングA = 「耳が痛い」「言い足りない」「銀歯みたい」(すべて「〜い」で終わる)
- 同じライミングのコロケーションを連続使用すると**ライミングチェーン**ボーナス

### タイプ
- コロケーションの内容・雰囲気を示す属性
- 相手のタイプとの相性によって得点が変動
- プレイヤーには完全には表示されず、ヒント形式で提示

---

## システム構成

### 1. 事前構築フェーズ(デッキ構築)

#### プレイヤーの所持カード
- コロケーション30~40個を所持(ゲーム進行で解放)
- バトルに持ち込むのは**15~20個**

#### デッキ構築の戦略性
- **ライミングバランス**:ライミングA系5個、ライミングB系4個、ライミングC系3個...のようにバランス調整
- **タイプバランス**:攻撃的 vs 防御的 vs バランス型
- **MVP版では敵は1体のみ**なので、その敵の特性に合わせた調整

#### デッキコンセプトの例
- ライミング特化型:特定のライミングを多く入れて大チェーン狙い(ハイリスク・ハイリターン)
- 分散型:複数のライミングを均等に配置して柔軟に対応(安定型)
- カウンター型:#カウンター系を多めに積んで相手の攻撃を利用

---

### 2. バトルフェーズ

#### 相手ターン(約8秒)
相手のラップが再生される

**プレイヤーに表示される情報:**
```
相手「お前のスタイルは時代遅れ」

ヒント表示:
💬 雰囲気:攻撃的
🎵 韻:A系(〜い、〜ない)
```

**重要:タイプの詳細は非表示**
- 完全な情報は与えず、プレイヤーが推測する余地を残す
- 文章とヒントから相手の意図を読み取る

---

#### ビート・準備フェーズ(約8秒)
ビートだけが流れ、プレイヤーは次の攻撃を組み立てる

**やること:**
1. 手札(15~20個)の中から**4つのコロケーション**を選択
2. 選んだ4つを**順序を考えて配置**
3. 確定ボタンを押す

**判断基準:**
- **相手の雰囲気読み**:攻撃的→カウンター系で返す?
- **ライミングチェーン戦略**:ライミングA系を3枚使って大コンボ? or 1枚だけで温存?
- **リソース管理**:このライミンググループを使い切っても大丈夫?
- **HP状況**:劣勢なら大ダメージ狙い、優勢なら安定重視

**駆け引きの核心:**
- 完璧な選択肢(タイプ相性◎ & ライミングチェーン◎)が常にあるとは限らない
- ライミングを優先するかタイプ相性を優先するかのトレードオフ
- ライミングのリソース管理(今使い切るか、次ターンに温存するか)

---

#### 攻撃フェーズ(約8秒)
選択したコロケーションが音楽に合わせて再生される

**流れ:**
```
♪ドンドン♪
→ コロケーション1「綺麗ごとばっかで耳が痛い」(自動再生)

♪ドン♪
→ アドリブワード「yo」(自動挿入) ← プレイヤーはタイミングでタップ

♪ドンドン♪
→ コロケーション2「まだまだ悪口言い足りない」(自動再生)

♪ドン♪
→ アドリブワード「マジで」(自動挿入) ← タップ

♪ドン♪
→ アドリブワード「おまえ」(自動挿入) ← タップ

♪ドンドン♪
→ コロケーション3「歯にあるアクセサリー?」(自動再生)

♪ドンドン♪
→ コロケーション4「じいちゃんがしてる銀歯みたい」(自動再生)

♪ドン♪
→ アドリブワード「ハハ」(自動挿入) ← タップ
```

**プレイヤーの操作:**
- 画面下部に**常設の2つのボタン**を配置
  - **メインボタン**(中央): コロケーション再生タイミングで押す
  - **フィラーボタン**(隣): フィラー再生タイミングで押す
- 画面上部でラップテキストを順次表示
- タイミングマーカー(円が縮小など)でリズムをガイド
- タップのタイミング精度で判定(Perfect/Good/Bad)

**UI構成:**
```
┌─────────────────────────┐
│  ラップテキスト表示        │ ← アニメーション
│ 「綺麗ごとで耳が痛い」     │
│         ⭕              │ ← タイミングマーカー
│                         │
│                         │
│  [メインボタン] [フィラー]  │ ← 常設ボタン
└─────────────────────────┘
```

**スコアリング:**
- メインボタン: コロケーション4回分のタイミング判定
- フィラーボタン: フィラー3回程度のタイミング判定
- 両方の判定を合算してリズム評価を算出

**重要:**
- フィラーは自動挿入(プレイヤーは選択しない)
- 文章の繋がりを自然にする役割
- リズムゲーム要素として機能
- ボタンは常に表示され、いつでも押せる(タイミング外は低評価)

---

#### 結果判定

**評価の3要素:**

1. **リズム評価**(技術点)
   - アドリブワードのタップ精度
   - Perfect/Good/Badの割合で計算
   - 配点:全体の20~30%

2. **ライミング評価**(戦略点)
   - ライミングチェーンの有無と長さ
   - 同じライミンググループの連続使用で倍率増加
   - 例:ライミングA 1回→1.0倍、2連続→1.5倍、3連続→2.0倍、4連続→3.0倍
   - 配点:全体の40~50%

3. **タイプ評価**(戦術点)
   - 相手のタイプとの相性
   - 例:相手#挑発 に対して #カウンター = 1.5倍
   - ヒントから推測して適切なタイプを選べたか
   - 配点:全体の30~40%

**スコア表示例:**
```
========= 結果 =========
リズム評価: 70点 (Good多め)
ライミング評価: 90点 (ライミングA 3チェーン!)
タイプ評価: 80点 (雰囲気マッチ+相性ボーナス)
-----------------------
総合スコア: 85点
→ 相手に大ダメージ!

使用したライミング:
ライミングA(残り2枚) ← リソース減少
ライミングB(残り4枚)
ライミングC(残り3枚)
=======================
```

**リソース管理:**
- 使用したコロケーションは**そのバトル中使い切り**
- 特にライミングチェーンを狙った場合、同じライミンググループが枯渇
- 次ターンでの選択肢が制限される
- 「今大コンボで攻めるか、温存して長期戦に備えるか」の判断が重要

---

### 3. 敵キャラクター設定(MVP版)

**MVP版では敵は1体のみ**

#### 敵キャラ「ストリート・ファイター」(仮称)
- バランス型の敵キャラクター
- #攻撃、#挑発、#自慢をバランスよく使用
- ライミングチェーンもそれなりに狙ってくる
- プレイヤーが基本を学ぶための相手

**将来的な拡張(フェーズ2以降):**
対戦相手の各キャラクターには**タイプの偏り**がある

#### 例:キャラA「アグレッシブ・ラッパー」
- #攻撃 #挑発 系のコロケーションを多用
- 序盤から圧力をかけてくるスタイル
- **対策**:#カウンター #無視 系を厚めに組む

#### 例:キャラB「テクニカル・ラッパー」
- #理詰め #比喩 系のコロケーションを多用
- ライミングチェーンを重視するスタイル
- **対策**:ライミングを分散して柔軟に対応

#### 例:キャラC「カウンターパンチャー」
- #カウンター #反論 系のコロケーションを多用
- 後手から巻き返すスタイル
- **対策**:こちらも#カウンター系で読み合い、または#挑発で誘導

**学習要素(フェーズ2以降):**
- 初見では相手の特性は不明
- 対戦を重ねることで「このキャラはこういう傾向」と理解
- 次戦でデッキを調整してリベンジ
- **このサイクルがゲームの深みを生む**

---

## 駆け引きの構造(4層)

### 1層目:デッキ構築
- どのライミンググループをどれだけ入れるか
- タイプバランス(攻撃的 vs 防御的 vs バランス)
- MVP版では敵1体なので、その特性に合わせた調整

### 2層目:リソース管理(ライミングの温存)
- ライミングチェーンで大ダメージ vs 温存して長期戦
- 現在のHP・残りターン数との相談
- 使い切りのタイミング判断

### 3層目:タイプ読み(推測と文章判断)
- ヒントから相手のタイプを推測
- 手札の文章を読んで適切な返しを選択
- 完璧な選択肢がない時の妥協

### 4層目:技術(リズムゲーム)
- タイミング精度
- これは最低限(他の要素が良ければカバー可能)

---

## ゲームサイクル(フェーズ2以降の複数キャラ時)

```
[初見対戦]
「このキャラ強い...#攻撃系ばかりだ」
「ライミングAを使い切ったら後半苦しくなった」

↓

[デッキ調整]
「次は#カウンター系を増やそう」
「ライミングAを多めにしてチェーン狙いで勝負」

↓

[再戦]
「読み通り!#カウンターが刺さる!」
「ライミングA 4チェーンで大ダメージ!」
「でもライミングAを使い切った...残りターンどうする」

↓

[さらに調整]
「ライミングAだけじゃなくライミングBも混ぜて柔軟性を」
「相手の特性が分かってきた、メタデッキを組もう」
```

**MVP版では:**
- 敵1体なので、デッキ調整の要素は薄い
- リソース管理とタイプ読みの練習がメイン
- 拡張版で複数キャラが追加されると、このサイクルが本格化

---

## 実装の優先順位

### フェーズ1(MVP):確定採用
- タグ相性システム(ルールベース)
- 韻連鎖システム(ルールベース)
- アドリブ自動挿入(リズムゲーム要素)
- キャラクター特性システム
- ヒント表示(タグ非表示、雰囲気+韻のみ)

**これだけで十分なゲームとして成立**

### フェーズ2(拡張):将来的に検討
- 文脈継続評価(AI活用、ボーナス点)
- アドリブの選択要素(3択から選ぶ)
- アドリブによる意味の変化
- メタゲーム要素(相手の次の手を読む)

---

## 技術検討事項

### タイプ相性テーブル(ルールベース)
```
相手のタイプ    → 有効なタイプ       → ボーナス倍率
#挑発         → #カウンター      → 1.5倍
#挑発         → #無視           → 1.3倍
#自慢         → #侮辱           → 1.3倍
#質問         → #回答           → 1.4倍
#攻撃         → #防御           → 1.2倍
#攻撃         → #反撃           → 1.5倍
```

### ライミングチェーンの倍率
```
チェーン数     → 倍率
1回       → 1.0倍(ベース)
2連続     → 1.5倍
3連続     → 2.0倍
4連続     → 3.0倍
5連続以上 → 4.0倍(理論上の最大)
```

### スコアリング配分(暫定)
- リズム評価:25%
- ライミング評価:45%
- タイプ評価:30%

---

## データ設計(今後詰める項目)

### コロケーションデータ(確定)

#### ライミングA: 〜い系 (iai) - 9個
```javascript
{ id: "a01", text: "じいちゃんの銀歯みたい", type: "#攻撃", rhyming: "A" }
{ id: "a02", text: "綺麗ごとで耳が痛い", type: "#攻撃", rhyming: "A" }
{ id: "a03", text: "常に前だけ見てる後ろ見ない", type: "#夢中", rhyming: "A" }
{ id: "a04", text: "これはただの消化試合", type: "#攻撃", rhyming: "A" }
{ id: "a05", text: "そんなの関係ない", type: "#カウンター", rhyming: "A" }
{ id: "a06", text: "お前こそ痛い", type: "#カウンター", rhyming: "A" }
{ id: "a07", text: "まだまだ言葉がいい足りない", type: "#夢中", rhyming: "A" }
{ id: "a08", text: "ポルシェをもう一台買いたい", type: "#自慢", rhyming: "A" }
{ id: "a09", text: "君はここで敗退", type: "#攻撃", rhyming: "A" }
```

#### ライミングB: 〜あ系 (aaa) - 8個
```javascript
{ id: "b01", text: "ここで抜く刀", type: "#自慢", rhyming: "B" }
{ id: "b02", text: "大丈夫か頭", type: "#攻撃", rhyming: "B" }
{ id: "b03", text: "勝てると思うな馬鹿が", type: "#攻撃", rhyming: "B" }
{ id: "b04", text: "あがってく心と体", type: "#夢中", rhyming: "B" }
{ id: "b05", text: "陸に上がった魚", type: "#攻撃", rhyming: "B" }
{ id: "b06", text: "おれは日本の宝", type: "#自慢", rhyming: "B" }
{ id: "b07", text: "お前のスキルまだまだだ", type: "#カウンター", rhyming: "B" }
{ id: "b08", text: "それじゃおれには敵わん", type: "#カウンター", rhyming: "B" }
```

#### ライミングC: 〜ん系 (aua) - 7個
```javascript
{ id: "c01", text: "おまえはここではお客さん", type: "#攻撃", rhyming: "C" }
{ id: "c02", text: "ここでかます爆弾", type: "#自慢", rhyming: "C" }
{ id: "c03", text: "はじめますかまずは", type: "#夢中", rhyming: "C" }
{ id: "c04", text: "見せつけるお前との落差", type: "#自慢", rhyming: "C" }
{ id: "c05", text: "俺のリスナーがたくさん", type: "#自慢", rhyming: "C" }
{ id: "c06", text: "言葉返すサルが", type: "#カウンター", rhyming: "C" }
{ id: "c07", text: "きかない言葉の軽さ", type: "#カウンター", rhyming: "C" }
```

#### ライミングD: 〜イフ系 (aiu) - 8個
```javascript
{ id: "d01", text: "これがマイライフ", type: "#夢中", rhyming: "D" }
{ id: "d02", text: "パンパンになった財布", type: "#自慢", rhyming: "D" }
{ id: "d03", text: "言葉はまるでナイフ", type: "#自慢", rhyming: "D" }
{ id: "d04", text: "ありがとう今日のライブ", type: "#夢中", rhyming: "D" }
{ id: "d05", text: "たいしたことない小細工", type: "#攻撃", rhyming: "D" }
{ id: "d06", text: "いらないアドバイス", type: "#攻撃", rhyming: "D" }
{ id: "d07", text: "返してもらうマイク", type: "#カウンター", rhyming: "D" }
{ id: "d08", text: "それはラップじゃなくて俳句", type: "#カウンター", rhyming: "D" }
```

**合計: 32個**

#### タイプ別集計
- #攻撃: 12個 (37.5%)
- #自慢: 10個 (31.3%)
- #夢中: 6個 (18.8%)
- #カウンター: 8個 (25.0%)

#### ライミング別集計
- ライミングA: 9個
- ライミングB: 8個
- ライミングC: 7個
- ライミングD: 8個

---

### フィラーデータ(確定)

```javascript
{ id: "f01", text: "ya" }
{ id: "f02", text: "エイ" }
```

**自動挿入ロジック:**
- コロケーション間のリズムの隙間にランダムで挿入
- プレイヤーはタイミングに合わせてタップするのみ

**実装状況:**
- ✅ 2種類のフィラー実装済み
- ✅ 自動挿入・タップ判定実装済み
- 📝 将来的に"マジで"、"おまえ"、"ハハ"なども追加予定

---

### タイプ定義(確定)

#### #攻撃
相手のラップスキルや外見を貶す
- 例:「見た目が微妙」「声が悪い」「やる気がない」「下手くそ」

#### #自慢
自分の実力や成功をアピール
- 例:「俺はすごい」「頑張ってる」「金稼いでる」「イケてる」

#### #夢中
自分のスタイルや楽しさを表現、マイペース
- 例:「気にせず好きにやる」「歌って楽しい」「飯がうまく感じる」「ハイになる」

#### #カウンター
相手の攻撃や主張に反論・切り返し
- 例:「お前こそ」「それがどうした」「見せてやる」「黙らせる」

---

### タイプ相性テーブル(確定)

```
相手のタイプ    → 有効なタイプ       → ボーナス倍率
#攻撃         → #カウンター      → 1.5倍
#攻撃         → #夢中           → 1.3倍
#自慢         → #攻撃           → 1.3倍
#自慢         → #カウンター      → 1.2倍
#夢中         → #攻撃           → 1.2倍
#カウンター   → #自慢           → 1.3倍
```

---

### MVP ゲームフロー(確定)

```
[ゲーム開始]
  ↓
[デッキ選択]
- 所持32個のコロケーションから15~20個を選んで持ち込み
  ↓
[バトル開始]
  ↓
[ターン1:相手の攻撃](約8秒)
- 相手のラップ再生
- ヒント表示:雰囲気 + ライミング種類
  ↓
[ターン2:自分のターン]
  [準備フェーズ](約8秒)
  - 4小節のビート中に手札から4つのコロケーション選択・配置
  [攻撃フェーズ](約8秒)
  - 配置したコロケーション自動再生
  - フィラーのタイミングでタップ(Perfect/Good/Bad)
  [結果判定]
  - リズム評価・ライミング評価・タイプ評価
  ↓
[ターン3:相手の攻撃](約8秒)
  ↓
[ターン4:自分のターン]
  [準備フェーズ・攻撃フェーズ・結果判定]
  ↓
[最終判定]
- 2ターン分の総合得点を計算
- 150点以上(各ターン最大100点)で勝利
  ↓
[勝敗表示]
```

---

### 敵キャラクター設定(確定)

**MVP版では敵は1体のみ**

#### 敵キャラ「ストリート・ファイター」
- バランス型の敵キャラクター
- #攻撃、#挑発、#自慢をバランスよく使用
- ライミングチェーンもそれなりに狙ってくる
- プレイヤーが基本を学ぶための相手
- 難易度:初級〜中級

**実装状況:**
- ✅ 敵のオリジナルラップシステム実装済み
- ターン1: 3種類のラップからランダム選択
  - "お前のライムはぬるま湯みたい" (A系韻)
  - "俺の前じゃお前は赤ん坊" (B系韻)
  - "お前のスキルはまだまだ" (B系韻)
- ターン2: 3種類のラップからランダム選択
  - "お前の言葉は軽い" (A系韻)
  - "俺のフロウは止まらん" (C系韻)
  - "まだまだ修行が足りん" (C系韻)
- チュートリアル用: "お前のスキルはまだまだだ" (固定)

---

### UI/UX
- 8秒で4枚選べるインターフェース
- ヒント表示の見せ方
- リソース(残りライミング)の可視化

---

## 実装の品質保証(バグ修正履歴)

### 実装完了機能

#### ✅ コア機能
- デッキ構築システム (15-20個選択)
- 2ターン制バトルフロー
- 敵ターン → 準備フェーズ(8秒) → 攻撃フェーズ → 結果判定
- リズムゲーム (Perfect/Good/Bad/Miss判定)
- ライミングチェーンシステム (1.0x → 1.5x → 2.0x → 3.0x → 4.0x)
- タイプ相性システム (最大1.5倍)
- スコアリング (リズム25% / ライミング45% / タイプ30%)
- 勝利条件判定 (2ターン合計150点以上で勝利)
- リソース管理 (使用済みコロケーション削除)

#### ✅ チュートリアルシステム
- レベル1チュートリアル実装
- ステップバイステップガイド
- 推奨カードハイライト
- チュートリアルモーダル

#### ✅ UI支援機能
- カードアノテーション (チェーン予測、タイプ相性、リソース警告)
- 残りデッキ表示
- ビジュアルエフェクト (タップエフェクト、コンボ表示)
- タイムライン表示

#### ✅ 音楽・音声システム (実装完了)
- Web Audio API によるプログラム生成ビート (BPM120)
- タップ判定音 (Perfect/Good/Bad/Miss)
- 音量調整機能 (BGM/効果音を個別に設定可能)
- ビート同期システム
- 設定ファイルでBPM、音量、ファイルパスを一元管理
- 音声ファイルの差し替えが容易な設計

#### 📝 未実装機能
- BGM音源ファイル (現在はプログラム生成ビートのみ)
- 音声合成 (コロケーション読み上げ) - 将来的に実装
- 複数敵キャラクター (フェーズ2)
- チュートリアルレベル2-3

---

## 音楽・音声システム

### アーキテクチャ

#### 使用ライブラリ
- **Howler.js** - Web Audio API のラッパー
  - 理由: シンプルなAPI、クロスブラウザ対応、音声スプライト対応
  - インストール: `npm install howler`
  - 型定義: `npm install --save-dev @types/howler`

#### ディレクトリ構成
```
public/
  audio/
    bgm/
      title.mp3          # タイトル画面BGM
      battle.mp3         # バトル画面BGM
    beat/
      kick.mp3           # キック音（BPM120の基準）
      snare.mp3          # スネア音
    sfx/
      tap-perfect.mp3    # Perfect判定音
      tap-good.mp3       # Good判定音
      tap-bad.mp3        # Bad判定音
      tap-miss.mp3       # Miss判定音
      select.mp3         # カード選択音
      confirm.mp3        # 確定音
      result.mp3         # 結果表示音
```

#### 設定ファイル (`lib/audio-config.ts`)
```typescript
export const AUDIO_CONFIG = {
  // BPM設定
  bpm: 120,

  // BGMファイルパス
  bgm: {
    title: '/audio/bgm/title.mp3',
    battle: '/audio/bgm/battle.mp3',
  },

  // ビート音ファイルパス
  beat: {
    kick: '/audio/beat/kick.mp3',
    snare: '/audio/beat/snare.mp3',
  },

  // 効果音ファイルパス
  sfx: {
    tapPerfect: '/audio/sfx/tap-perfect.mp3',
    tapGood: '/audio/sfx/tap-good.mp3',
    tapBad: '/audio/sfx/tap-bad.mp3',
    tapMiss: '/audio/sfx/tap-miss.mp3',
    select: '/audio/sfx/select.mp3',
    confirm: '/audio/sfx/confirm.mp3',
    result: '/audio/sfx/result.mp3',
  },

  // 音量設定（0.0 - 1.0）
  volume: {
    bgm: 0.5,
    beat: 0.7,
    sfx: 0.8,
  },
} as const;
```

#### 音楽マネージャー (`lib/audio-manager.ts`)
- シングルトンパターンで実装
- BGM、ビート、効果音の再生を一元管理
- BPM同期システム
- 音量調整機能

#### 主な機能
1. **BGM再生**
   - 画面遷移時の自動切り替え
   - ループ再生
   - フェードイン/フェードアウト

2. **ビート再生**
   - BPM120に同期したメトロノーム
   - 準備フェーズ・攻撃フェーズで使用
   - 視覚的タイミングマーカーと同期

3. **効果音**
   - タップ判定音（Perfect/Good/Bad/Miss）
   - UI操作音（選択、確定）
   - 結果表示音

4. **設定変更機能**
   - BPM変更（60-180）
   - 音量調整（BGM/ビート/効果音それぞれ独立）
   - 音声ファイルパスの変更

### ビート生成方式

#### オプション1: プログラム生成（Web Audio API）
- メリット: ファイル不要、BPM変更が容易
- デメリット: 音質がシンプル

#### オプション2: 音源ファイル使用
- メリット: 高品質な音
- デメリット: BPM変更時に再生成が必要

**採用: オプション1（プログラム生成）**
- 初期実装はプログラム生成
- 将来的に高品質音源に差し替え可能な設計

### 修正済みのクリティカル・バグ

#### 1. フィラータップ重複バグ
**問題:** 同じフィラーを複数回タップできてしまい、スコアが不正に増加する。また、表示中のフィラーではなくランダムなフィラーが記録されていた。

**修正内容:**
- `BattleAttackScreen.tsx`にシーケンス状態とインデックス追跡を追加
- 既にタップ済みかチェック: `tapResults.some((r) => r.filler.id === currentItem.filler.id)`
- 表示中のフィラーを使用: `currentItem.filler`を記録(ランダム取得を排除)

**影響範囲:** `components/screens/BattleAttackScreen.tsx`

#### 2. 準備フェーズのタイマー自動遷移の未実装
**問題:** 8秒のタイマーが0になっても攻撃フェーズへ自動遷移しない。プレイヤーが手動でボタンを押す必要があった。

**修正内容:**
- タイマーのuseEffectを修正し、`newTime <= 0`の時に`proceedToAttack()`を呼び出す
- 依存配列に`canProceedToAttack`と`proceedToAttack`を追加

**影響範囲:** `components/screens/BattlePrepareScreen.tsx`

#### 3. リソース枯渇時のエラーハンドリング不足
**問題:** 残りコロケーションが4個未満になった場合、プレイヤーがスロットを埋められないがエラー表示がない。

**修正内容:**
- useEffectを追加し、`remainingCollocations.all.length < GAME_CONFIG.TURN_COLLOCATIONS_COUNT`の時にconsole.errorで警告
- TODO: 今後UI上での警告表示を実装予定

**影響範囲:** `components/screens/BattlePrepareScreen.tsx`

#### 4. 型安全性の問題(非null断言の乱用)
**問題:** `enemy-data.ts`で`find()`の結果に`!`を使用し、見つからない場合のエラーハンドリングがない。

**修正内容:**
- `getRequiredCollocationById()`ヘルパー関数を作成
- 見つからない場合は詳細なエラーメッセージをthrow
- 非null断言(`!`)を完全に排除

**影響範囲:** `lib/enemy-data.ts`

#### 5. useEffect依存配列の不備
**問題:** 複数のコンポーネントでuseEffectの依存配列が不完全または不適切で、無限ループや意図しない再実行のリスクがあった。

**修正内容:**
- `BattlePrepareScreen.tsx`: タイマーの依存配列に`canProceedToAttack`と`proceedToAttack`を追加
- `BattleAttackScreen.tsx`: シーケンス生成を空の依存配列で初回のみ実行
- `EnemyTurnScreen.tsx`: `currentEnemyTurnInfo`への依存を削除し、マウント時のみ実行するように修正

**影響範囲:** `components/screens/BattlePrepareScreen.tsx`, `components/screens/BattleAttackScreen.tsx`, `components/screens/EnemyTurnScreen.tsx`

#### 6. タイムライン長の不一致
**問題:** 攻撃フェーズのタイムライン全体の長さ(16拍=8秒)とブロック長の合計(11拍=5.5秒)が一致せず、視覚的にずれが発生していた。

**修正内容:**
- `TOTAL_DURATION`を16拍から11拍(5500ms)に変更
- コロケーション4つ(各2拍) + フィラー3つ(各1拍) = 11拍で正確に計算

**影響範囲:** `components/screens/BattleAttackScreen.tsx`

#### 7. 敵ラップシステムの改善
**問題:** 敵がコロケーションデータから選択していたため、プレイヤーの選択肢と被り、会話がかみ合わない印象があった。

**修正内容:**
- `enemy-raps.ts`を新規作成し、敵専用のオリジナルラップを定義
- `EnemyTurnInfo`型を更新 (lyrics, type, rhymingフィールドを追加)
- ターンごとに異なるラップをランダム選択
- チュートリアル用の固定ラップも追加

**影響範囲:** `lib/enemy-raps.ts`, `lib/types.ts`, `lib/store.ts`, `components/screens/EnemyTurnScreen.tsx`, `components/screens/BattleAttackScreen.tsx`, `components/screens/BattlePrepareScreen.tsx`

#### 8. TypeScript型エラー修正
**問題:** `RhymingGroup`型に`"-"`が含まれていなかったため、イントロ/エンディング用コロケーションで型エラーが発生。

**修正内容:**
- `RhymingGroup`型に`"-"`を追加
- `Record<RhymingGroup, number>`を使用している箇所に`"-": 0`を追加

**影響範囲:** `lib/types.ts`, `components/screens/BattlePrepareScreen.tsx`, `components/ui/remaining-deck-display.tsx`

### コード品質の改善

- TypeScriptの型安全性を強化(非null断言の完全排除)
- Reactのベストプラクティスに準拠(useEffect依存配列の適切な管理)
- ゲームロジックの堅牢性向上(重複タップ防止、リソースチェック)
- 自動遷移の実装によるUX向上

---

## 補足:失敗の許容設計

**「ミスってもリカバリー」の思想**

- リズム判定でBad出ても**続行可能**
- スコアは下がるが、ターン自体は成立
- 「やり直し」ではなく「次のターンで挽回」
- 完璧主義ではなく「それっぽさ」を許容
- 3~5ターンの合計で勝敗を決めるので、1ターンのミスは致命的ではない

**段階的な失敗:**
- Good以上が多い → 高評価、相手にダメージ
- Bad多め → 低評価、自分がダメージ受ける
- でもゲームオーバーにはならず継続

---

## まとめ

このゲームの核心は:
1. **事前構築**での戦略(デッキ構築)
2. **準備フェーズ**での戦術(相手を読んで選択)
3. **攻撃フェーズ**でのアドリブと技術(リズムゲーム)
4. **リソース管理**での判断(韻の温存 vs 使い切り)

音ゲーの「タイミング精度が全て」ではなく、
ラップバトルの「韻・意味・リズム」のバランスを楽しむゲーム。

単純なじゃんけんではなく、
**トレードオフ**と**リソース管理**と**読み合い**が生む深い駆け引き。